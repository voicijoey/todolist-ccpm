const Database = require('../models/database');

class PreferencesController {
  constructor() {
    this.db = new Database();
  }

  async initialize() {
    await this.db.connect();
  }

  // Get user notification preferences
  async getPreferences(req, res) {
    try {
      const userId = req.user.userId;

      let preferences = await this.db.get(`
        SELECT * FROM user_preferences WHERE user_id = ?
      `, [userId]);

      // Create default preferences if none exist
      if (!preferences) {
        await this.db.run(`
          INSERT INTO user_preferences (user_id, email_enabled, browser_enabled, due_date_hours, digest_frequency)
          VALUES (?, 1, 1, 24, 'daily')
        `, [userId]);

        preferences = await this.db.get(`
          SELECT * FROM user_preferences WHERE user_id = ?
        `, [userId]);
      }

      res.json({
        success: true,
        data: {
          email_enabled: Boolean(preferences.email_enabled),
          browser_enabled: Boolean(preferences.browser_enabled),
          due_date_hours: preferences.due_date_hours,
          digest_frequency: preferences.digest_frequency
        }
      });
    } catch (error) {
      console.error('Error getting preferences:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to get notification preferences'
      });
    }
  }

  // Update user notification preferences
  async updatePreferences(req, res) {
    try {
      const userId = req.user.userId;
      const {
        email_enabled,
        browser_enabled,
        due_date_hours,
        digest_frequency
      } = req.body;

      // Validate input
      const validationErrors = this.validatePreferences({
        email_enabled,
        browser_enabled,
        due_date_hours,
        digest_frequency
      });

      if (validationErrors.length > 0) {
        return res.status(400).json({
          success: false,
          message: 'Invalid preferences data',
          errors: validationErrors
        });
      }

      // Check if preferences exist
      const existingPreferences = await this.db.get(`
        SELECT id FROM user_preferences WHERE user_id = ?
      `, [userId]);

      if (existingPreferences) {
        // Update existing preferences
        await this.db.run(`
          UPDATE user_preferences
          SET email_enabled = ?, browser_enabled = ?, due_date_hours = ?, digest_frequency = ?, updated_at = CURRENT_TIMESTAMP
          WHERE user_id = ?
        `, [
          email_enabled ? 1 : 0,
          browser_enabled ? 1 : 0,
          due_date_hours,
          digest_frequency,
          userId
        ]);
      } else {
        // Create new preferences
        await this.db.run(`
          INSERT INTO user_preferences (user_id, email_enabled, browser_enabled, due_date_hours, digest_frequency)
          VALUES (?, ?, ?, ?, ?)
        `, [
          userId,
          email_enabled ? 1 : 0,
          browser_enabled ? 1 : 0,
          due_date_hours,
          digest_frequency
        ]);
      }

      res.json({
        success: true,
        message: 'Notification preferences updated successfully'
      });
    } catch (error) {
      console.error('Error updating preferences:', error);
      res.status(500).json({
        success: false,
        message: 'Failed to update notification preferences'
      });
    }
  }

  validatePreferences(preferences) {
    const errors = [];

    // Validate email_enabled
    if (preferences.email_enabled !== undefined && typeof preferences.email_enabled !== 'boolean') {
      errors.push('email_enabled must be a boolean');
    }

    // Validate browser_enabled
    if (preferences.browser_enabled !== undefined && typeof preferences.browser_enabled !== 'boolean') {
      errors.push('browser_enabled must be a boolean');
    }

    // Validate due_date_hours
    if (preferences.due_date_hours !== undefined) {
      if (!Number.isInteger(preferences.due_date_hours) || preferences.due_date_hours < 1 || preferences.due_date_hours > 168) {
        errors.push('due_date_hours must be an integer between 1 and 168 (7 days)');
      }
    }

    // Validate digest_frequency
    if (preferences.digest_frequency !== undefined) {
      const validFrequencies = ['daily', 'weekly', 'never'];
      if (!validFrequencies.includes(preferences.digest_frequency)) {
        errors.push('digest_frequency must be one of: daily, weekly, never');
      }
    }

    return errors;
  }
}

module.exports = new PreferencesController();